<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Steam Analytics Dashboard</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png">
    <link rel="manifest" href="/site.webmanifest">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a1a2e;
        }

        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .auth-card {
            background: #ffffff;
            border-radius: 14px;
            padding: 32px;
            max-width: 360px;
            width: 100%;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .auth-card h2 {
            margin: 0;
            color: #4450d4;
            text-align: center;
        }

        .auth-card .auth-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .auth-card input {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(102, 126, 234, 0.25);
            font-size: 15px;
        }

        .auth-card button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .auth-card button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.35);
        }

        .auth-error {
            color: #e53e3e;
            font-size: 13px;
            text-align: center;
            min-height: 18px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            margin: 0;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .top-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            align-items: stretch;
        }

        .summary {
            flex: 1;
            min-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 22px;
            font-weight: bold;
            color: #667eea;
        }

        .timezone-card select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            font-size: 14px;
            color: #333;
        }

        .add-item-form {
            flex: 2;
            min-width: 320px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .add-item-form h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .item-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid #eef0ff;
            cursor: pointer;
        }

        .item-header h3 {
            color: #667eea;
            margin: 0;
        }

        .item-meta {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .toggle-hint {
            color: #667eea;
            font-size: 13px;
            font-weight: 500;
        }

        .item-section[data-expanded="true"] .toggle-hint {
            color: #999;
        }

        .item-details {
            display: none;
            flex-direction: column;
            gap: 24px;
            margin-top: 12px;
        }

        .item-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .orders-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .orders-card {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 18px;
            border: 1px solid rgba(102, 126, 234, 0.15);
            min-height: 140px;
        }

        .orders-card h4 {
            color: #667eea;
            margin-bottom: 12px;
        }

        .orders-metric {
            font-size: 14px;
            margin-bottom: 6px;
            color: #555;
        }

        .orders-metric strong {
            color: #333;
        }

        .orders-levels {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(102, 126, 234, 0.15);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .orders-level {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #555;
        }

        .orders-remark {
            margin-top: 10px;
            color: #888;
            font-size: 12px;
        }

        .period-section {
            background: #fafbff;
            border-radius: 10px;
            padding: 18px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .period-section h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .period-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin-bottom: 18px;
        }

        .period-controls .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .period-controls .control-group select,
        .period-controls .control-group input[type="date"] {
            min-width: 140px;
            padding: 8px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-secondary {
            background: #f0f2ff;
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 6px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: #fff;
        }

        .period-tables {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .period-day {
            background: #f4f6ff;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.15);
        }

        .period-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            cursor: pointer;
        }

        .period-day-title {
            font-size: 14px;
            font-weight: 600;
            color: #5560d3;
        }

        .period-day-toggle {
            font-size: 13px;
            color: #667eea;
            font-weight: 500;
        }

        .period-day[data-expanded="true"] .period-day-toggle {
            color: #999;
        }

        .period-day-content {
            display: none;
            padding: 16px 18px 20px;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
            overflow-x: auto;
        }

        .period-row-columns {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .period-time-column {
            background: rgba(255, 255, 255, 0.75);
            border-radius: 8px;
            padding: 12px;
            min-width: 140px;
            border: 1px solid rgba(102, 126, 234, 0.12);
            flex-shrink: 0;
        }

        .period-time-label {
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            text-align: center;
            margin-bottom: 8px;
        }

        .period-entry {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            font-size: 13px;
            padding: 6px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.65);
            margin-bottom: 6px;
        }

        .period-entry:nth-child(odd) {
            background: rgba(255, 255, 255, 0.9);
        }

        .period-entry-price {
            color: #333;
        }

        .period-entry-qty {
            color: #666;
            font-variant-numeric: tabular-nums;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .status-banner {
            display: none;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-banner.info {
            background: rgba(102, 126, 234, 0.15);
            color: #233876;
        }

        .status-banner.error {
            background: #ff6b6b;
            color: #fff;
        }

        .status-banner.success {
            background: #28a745;
            color: #fff;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .control-group label {
            font-size: 14px;
            color: #666;
        }

        .control-group select {
            padding: 8px;
            border: 2px solid #eee;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="auth-overlay" id="authOverlay" style="display:flex;">
        <div class="auth-card">
            <h2>–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å</h2>
            <div class="auth-field">
                <label for="authLogin">–õ–æ–≥–∏–Ω</label>
                <input type="text" id="authLogin" autocomplete="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
            </div>
            <div class="auth-field">
                <label for="authPassword">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="authPassword" autocomplete="current-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button type="button" id="authSubmit">–í–æ–π—Ç–∏</button>
            <div class="auth-error" id="authError"></div>
        </div>
    </div>

    <div class="container" id="appContainer" style="display:none;">
        <div class="header">
            <h1>üéÆ Steam Analytics Dashboard</h1>
            <div>
                <button class="btn btn-success" onclick="triggerCollection()" id="collectBtn">
                    –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
                </button>
                <button class="btn" onclick="loadData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>

        <div id="statusBanner" class="status-banner" style="display: none;"></div>

        <div class="top-layout">
            <div class="add-item-form">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h2>
                <form onsubmit="addItem(event)">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</label>
                        <input type="text" id="itemName" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: AK-47 | Redline">
                    </div>
                    <div class="form-group">
                        <label>Item ID (–∏–∑ Steam)</label>
                        <input type="text" id="itemId" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 176358786">
                    </div>
                    <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                </form>
            </div>

            <div class="summary" id="summary">
                <div class="summary-card">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h3>
                    <div class="value" id="lastUpdate" style="font-size: 14px;">-</div>
                </div>
                <div class="summary-card">
                    <h3>–í—Å–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
                    <div class="value" id="totalItems">-</div>
                </div>
                <div class="summary-card timezone-card">
                    <h3>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</h3>
                    <select id="timezone-select">
                        <option value="-720">UTC-12</option>
                        <option value="-420">UTC-7</option>
                        <option value="-300">UTC-5</option>
                        <option value="0">UTC</option>
                        <option value="60">UTC+1</option>
                        <option value="120">UTC+2</option>
                        <option value="180" selected>UTC+3</option>
                        <option value="240">UTC+4</option>
                        <option value="300">UTC+5</option>
                        <option value="360">UTC+6</option>
                        <option value="420">UTC+7</option>
                        <option value="480">UTC+8</option>
                        <option value="540">UTC+9</option>
                        <option value="600">UTC+10</option>
                        <option value="660">UTC+11</option>
                        <option value="720">UTC+12</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="items" style="display: none;"></div>
    </div>

    <script>
        let currentTimezoneOffsetMinutes = 180;
        const timezoneAwarePattern = /(z|Z|[+-]\d{2}:?\d{2})$/;
        const AUTH_KEY = 'steam-analytics-auth';
        let refreshIntervalId = null;

        function setStatus(message, variant = 'info') {
            const banner = document.getElementById('statusBanner');
            if (!banner) {
                return;
            }

            if (message) {
                banner.textContent = message;
                banner.classList.remove('info', 'error', 'success');
                banner.classList.add(variant);
                banner.style.display = 'block';
            } else {
                banner.textContent = '';
                banner.style.display = 'none';
            }
        }

        async function addItem(event) {
            event.preventDefault();

            if (!isAuthenticated()) {
                requireAuth();
                return;
            }

            const nameInput = document.getElementById('itemName');
            const itemIdInput = document.getElementById('itemId');
            const submitButton = event?.target?.querySelector('button[type="submit"]');

            const name = nameInput?.value?.trim();
            const itemId = itemIdInput?.value?.trim();

            if (!name || !itemId) {
                setStatus('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞.', 'error');
                return;
            }

            const originalButtonText = submitButton?.textContent;

            try {
                setStatus('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞...', 'info');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
                }

                const response = await fetch('/api/analytics/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, itemId })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }

                await response.json();

                if (nameInput) nameInput.value = '';
                if (itemIdInput) itemIdInput.value = '';

                setStatus('–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω. –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ...', 'success');
                await loadData();
            } catch (error) {
                console.error('Error adding item:', error);
                setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç: ' + error.message, 'error');
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText || '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç';
                }
            }
        }

        async function triggerCollection() {
            if (!isAuthenticated()) {
                requireAuth();
                return;
            }

            const collectButton = document.getElementById('collectBtn');
            const originalText = collectButton?.textContent;

            try {
                setStatus('–ó–∞–ø—É—Å–∫–∞—é —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...', 'info');
                if (collectButton) {
                    collectButton.disabled = true;
                    collectButton.textContent = '–ó–∞–ø—É—Å–∫...';
                }

                const response = await fetch('/api/analytics/collect', { method: 'POST' });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }

                setStatus('–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—â–µ–Ω. –û–±–Ω–æ–≤–ª—è—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...', 'success');
                setTimeout(() => {
                    loadData();
                }, 3000);
            } catch (error) {
                console.error('Error triggering collection:', error);
                setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä: ' + error.message, 'error');
            } finally {
                if (collectButton) {
                    collectButton.disabled = false;
                    collectButton.textContent = originalText || '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö';
                }
            }
        }

        function startAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
            }
            refreshIntervalId = setInterval(() => {
                if (isAuthenticated()) {
                    loadData();
                }
            }, 5 * 60 * 1000);
        }

        function isAuthenticated() {
            try {
                const stored = localStorage.getItem(AUTH_KEY);
                if (!stored) return false;
                const parsed = JSON.parse(stored);
                return parsed?.login === 'gvak' && parsed?.token === 'granted';
            } catch {
                return false;
            }
        }

        function requireAuth() {
            const overlay = document.getElementById('authOverlay');
            const container = document.getElementById('appContainer');

            if (isAuthenticated()) {
                if (overlay) overlay.style.display = 'none';
                if (container) container.style.display = 'block';
                return true;
            }

            if (container) container.style.display = 'none';
            if (overlay) overlay.style.display = 'flex';
            return false;
        }

        function handleLogin() {
            const loginInput = document.getElementById('authLogin');
            const passwordInput = document.getElementById('authPassword');
            const errorBox = document.getElementById('authError');

            const login = loginInput?.value?.trim();
            const password = passwordInput?.value || '';

            if (login === 'gvak' && password === 'n<U.H@+)4*zh#{u') {
                localStorage.setItem(AUTH_KEY, JSON.stringify({ login: 'gvak', token: 'granted' }));
                if (errorBox) errorBox.textContent = '';
                if (loginInput) loginInput.value = '';
                if (passwordInput) passwordInput.value = '';
                requireAuth();
                loadData();
                startAutoRefresh();
            } else {
                if (errorBox) errorBox.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
            }
        }

        function setupAuthHandlers() {
            const submitBtn = document.getElementById('authSubmit');
            const passwordInput = document.getElementById('authPassword');

            if (submitBtn) {
                submitBtn.addEventListener('click', handleLogin);
            }

            if (passwordInput) {
                passwordInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
        }

        function parseAsUtc(value) {
            if (!value && value !== 0) return null;

            if (value instanceof Date) {
                const copy = new Date(value.getTime());
                return Number.isNaN(copy.getTime()) ? null : copy;
            }

            if (typeof value === 'number') {
                const fromNumber = new Date(value);
                return Number.isNaN(fromNumber.getTime()) ? null : fromNumber;
            }

            if (typeof value === 'string') {
                let isoString = value.trim();
                if (!isoString) return null;

                if (!timezoneAwarePattern.test(isoString)) {
                    isoString += 'Z';
                }

                const parsed = new Date(isoString);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
            }

            return null;
        }

        function applyTimezone(rawUtcDate) {
            if (!(rawUtcDate instanceof Date) || Number.isNaN(rawUtcDate.getTime())) {
                return null;
            }

            const utcMillis = rawUtcDate.getTime();
            return new Date(utcMillis + currentTimezoneOffsetMinutes * 60000);
        }

        function convertToTimezone(value) {
            const utcDate = parseAsUtc(value);
            if (!utcDate) return null;
            return applyTimezone(utcDate);
        }

        function formatDateTime(value) {
            const tzDate = convertToTimezone(value);
            if (!tzDate) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            return tzDate.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'UTC'
            });
        }

        function formatTime(value) {
            const tzDate = convertToTimezone(value);
            if (!tzDate) return '--:--';
            return tzDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', timeZone: 'UTC' });
        }

        function formatCurrency(value) {
            const num = Number(value);
            if (Number.isNaN(num)) return '‚Äî';
            return `${num.toFixed(2)} ‚Ç∏`;
        }

        function formatQuantity(value) {
            const num = Number(value);
            if (Number.isNaN(num)) return '‚Äî';
            return num.toLocaleString('ru-RU');
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getPeriodElements(itemId) {
            return {
                controls: document.getElementById(`period-controls-${itemId}`),
                orderTypeSelect: document.getElementById(`order-type-${itemId}`),
                modeSelect: document.getElementById(`period-mode-${itemId}`),
                periodSelect: document.getElementById(`period-${itemId}`),
                startInput: document.getElementById(`period-start-${itemId}`),
                endInput: document.getElementById(`period-end-${itemId}`),
                applyButton: document.getElementById(`period-apply-${itemId}`),
                tablesContainer: document.getElementById(`period-tables-${itemId}`)
            };
        }

        async function loadData() {
            if (!isAuthenticated()) {
                return;
            }

            setStatus('');
            const loadingEl = document.getElementById('loading');
            const itemsContainer = document.getElementById('items');

            try {
                if (loadingEl) loadingEl.style.display = 'block';
                if (itemsContainer) itemsContainer.style.display = 'none';

                const summaryRes = await fetch('/api/analytics/summary');
                if (!summaryRes.ok) {
                    throw new Error(`HTTP error! status: ${summaryRes.status}`);
                }
                const summary = await summaryRes.json();

                const totalItemsEl = document.getElementById('totalItems');
                const lastUpdateEl = document.getElementById('lastUpdate');
                if (totalItemsEl) {
                    totalItemsEl.textContent = (summary.totalItems ?? 0).toLocaleString('ru-RU');
                }
                if (lastUpdateEl) {
                    if (summary.lastUpdate && summary.lastUpdate !== '0001-01-01T00:00:00') {
                        lastUpdateEl.textContent = formatDateTime(summary.lastUpdate);
                    } else {
                        lastUpdateEl.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                    }
                }

                const itemsRes = await fetch('/api/analytics/items');
                if (!itemsRes.ok) {
                    throw new Error(`HTTP error! status: ${itemsRes.status}`);
                }
                const items = await itemsRes.json();

                const itemBlocks = await Promise.all(items.map(async (item) => {
                    try {
                        const analyticsRes = await fetch(`/api/analytics/items/${item.id}/analytics`);
                        if (!analyticsRes.ok) {
                            const errorText = await analyticsRes.text();
                            console.error(`Failed to load analytics for item ${item.id}: ${analyticsRes.status} - ${errorText}`);
                            return renderErrorItem(item, `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö (HTTP ${analyticsRes.status})`);
                        }
                        const analytics = await analyticsRes.json();
                        return renderItem(item, analytics);
                    } catch (error) {
                        console.error(`Error loading analytics for item ${item.id}:`, error);
                        return renderErrorItem(item, `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
                    }
                }));

                if (!itemsContainer) {
                    throw new Error('Items container not found');
                }

                itemsContainer.innerHTML = itemBlocks.join('');
                itemsContainer.style.display = 'block';
                if (loadingEl) loadingEl.style.display = 'none';

                items.forEach(item => {
                    const header = document.querySelector(`#item-${item.id} .item-header`);
                    const {
                        orderTypeSelect,
                        modeSelect,
                        periodSelect,
                        applyButton
                    } = getPeriodElements(item.id);

                    if (header) {
                        header.addEventListener('click', () => toggleItemDetails(item.id));
                    }
                    if (orderTypeSelect) {
                        orderTypeSelect.addEventListener('change', () => loadPeriodAnalytics(item.id));
                    }
                    if (modeSelect) {
                        modeSelect.addEventListener('change', () => {
                            updatePeriodControlsVisibility(item.id);
                            if (modeSelect.value === 'relative') {
                                loadPeriodAnalytics(item.id);
                            }
                        });
                    }
                    if (periodSelect) {
                        periodSelect.addEventListener('change', () => loadPeriodAnalytics(item.id));
                    }
                    if (applyButton) {
                        applyButton.addEventListener('click', () => loadPeriodAnalytics(item.id));
                    }

                    updatePeriodControlsVisibility(item.id);
                });
            } catch (error) {
                console.error('Error loading data:', error);
                setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
                if (loadingEl) loadingEl.style.display = 'none';
            }
        }

        function renderErrorItem(item, message) {
            return `
                <div class="item-section">
                    <div class="item-header">
                        <div>
                            <h3>${item.name}</h3>
                            <div class="item-meta">ID: ${item.itemId}</div>
                        </div>
                        <span class="toggle-hint">–û—à–∏–±–∫–∞</span>
                    </div>
                    <div class="item-details" style="display:block;">
                        <p style="color: red; padding: 20px;">${message}</p>
                    </div>
                </div>
            `;
        }

        function renderItem(item, analytics) {
            const lastUpdated = formatDateTime(item.lastUpdated);

            return `
                <div class="item-section" id="item-${item.id}" data-expanded="false">
                    <div class="item-header">
                        <div>
                            <h3>${item.name}</h3>
                            <div class="item-meta">ID: ${item.itemId} | –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${lastUpdated}</div>
                        </div>
                        <span class="toggle-hint" id="toggle-hint-${item.id}">–ü–æ–∫–∞–∑–∞—Ç—å</span>
                    </div>
                    <div class="item-details" id="item-details-${item.id}" data-expanded="false">
                        <div class="period-section">
                            <h4>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</h4>
                            <div class="period-controls" id="period-controls-${item.id}">
                                <div class="control-group">
                                    <label>–¢–∏–ø –∑–∞—è–≤–æ–∫:</label>
                                    <select id="order-type-${item.id}">
                                        <option value="buy">–ü–æ–∫—É–ø–∫–∞</option>
                                        <option value="sell">–ü—Ä–æ–¥–∞–∂–∞</option>
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label>–†–µ–∂–∏–º –ø–µ—Ä–∏–æ–¥–∞:</label>
                                    <select id="period-mode-${item.id}">
                                        <option value="relative" selected>–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π</option>
                                        <option value="range">–î–∏–∞–ø–∞–∑–æ–Ω</option>
                                    </select>
                                </div>
                                <div class="control-group relative-group">
                                    <label>–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω:</label>
                                    <select id="period-${item.id}">
                                        <option value="1">1 –¥–µ–Ω—å</option>
                                        <option value="3">3 –¥–Ω—è</option>
                                        <option value="7" selected>7 –¥–Ω–µ–π</option>
                                        <option value="14">14 –¥–Ω–µ–π</option>
                                        <option value="30">30 –¥–Ω–µ–π</option>
                                    </select>
                                </div>
                                <div class="control-group range-group" style="display:none;">
                                    <label>–°</label>
                                    <input type="date" id="period-start-${item.id}">
                                </div>
                                <div class="control-group range-group" style="display:none;">
                                    <label>–ü–æ</label>
                                    <input type="date" id="period-end-${item.id}">
                                </div>
                                <div class="control-group range-group" style="display:none;">
                                    <label style="visibility:hidden;">&nbsp;</label>
                                    <button type="button" class="btn-secondary" id="period-apply-${item.id}">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                            <div class="period-tables" id="period-tables-${item.id}">
                                <p style="color:#999;">–†–∞—Å–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleItemDetails(itemId) {
            const details = document.getElementById(`item-details-${itemId}`);
            const hint = document.getElementById(`toggle-hint-${itemId}`);
            const section = document.getElementById(`item-${itemId}`);

            if (!details || !hint || !section) return;

            const expanded = section.dataset.expanded === 'true';

            if (expanded) {
                details.style.display = 'none';
                section.dataset.expanded = 'false';
                details.dataset.expanded = 'false';
                hint.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
            } else {
                details.style.display = 'flex';
                section.dataset.expanded = 'true';
                details.dataset.expanded = 'true';
                hint.textContent = '–°–∫—Ä—ã—Ç—å';
                loadPeriodAnalytics(itemId);
            }
        }

        function togglePeriodDay(dayElement) {
            if (!dayElement) return;

            const content = dayElement.querySelector('.period-day-content');
            const toggle = dayElement.querySelector('.period-day-toggle');
            if (!content || !toggle) return;

            const expanded = dayElement.dataset.expanded === 'true';

            if (expanded) {
                content.style.display = 'none';
                dayElement.dataset.expanded = 'false';
                toggle.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
            } else {
                content.style.display = 'block';
                dayElement.dataset.expanded = 'true';
                toggle.textContent = '–°–∫—Ä—ã—Ç—å';
            }
        }

        function updatePeriodControlsVisibility(itemId) {
            const { modeSelect, controls, startInput, endInput } = getPeriodElements(itemId);
            if (!modeSelect || !controls) return;

            const relativeGroups = controls.querySelectorAll('.relative-group');
            const rangeGroups = controls.querySelectorAll('.range-group');

            if (modeSelect.value === 'range') {
                relativeGroups.forEach(group => group.style.display = 'none');
                rangeGroups.forEach(group => group.style.display = 'flex');
            } else {
                relativeGroups.forEach(group => group.style.display = 'flex');
                rangeGroups.forEach(group => group.style.display = 'none');
                if (startInput) startInput.value = '';
                if (endInput) endInput.value = '';
            }
        }

        async function loadPeriodAnalytics(itemId) {
            const details = document.getElementById(`item-details-${itemId}`);
            if (!details || details.dataset.expanded !== 'true') return;

            const {
                orderTypeSelect,
                modeSelect,
                periodSelect,
                startInput,
                endInput,
                tablesContainer
            } = getPeriodElements(itemId);

            if (!orderTypeSelect || !tablesContainer) return;

            const mode = modeSelect ? modeSelect.value : 'relative';
            const orderType = orderTypeSelect.value || 'buy';
            const defaultDays = Number(periodSelect?.value || 7);
            const startValue = startInput?.value || '';
            const endValue = endInput?.value || '';

            let queryDays = defaultDays;

            if (mode === 'range') {
                if (startValue && endValue && startValue <= endValue) {
                    const diffMillis = new Date(endValue) - new Date(startValue);
                    const diffDays = Math.max(1, Math.ceil(diffMillis / 86400000) + 1);
                    queryDays = diffDays;
                } else {
                    tablesContainer.innerHTML = '<p style="color:#999;">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è.</p>';
                    return;
                }
            }

            tablesContainer.innerHTML = '<p style="color:#667eea;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>';

            try {
                const res = await fetch(`/api/analytics/items/${itemId}/price-history?buyOrders=${orderType === 'buy'}&days=${queryDays}`);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }

                const data = await res.json();
                let records = orderType === 'buy' ? (data.buy || []) : (data.sell || []);

                const processed = records.map(entry => {
                    const tzDate = convertToTimezone(entry.collectedAt);
                    return {
                        tzDate,
                        price: Number(entry.price),
                        quantity: Number(entry.quantity)
                    };
                }).filter(entry => entry.tzDate);

                let filtered = processed;
                if (mode === 'range') {
                    filtered = processed.filter(entry => {
                        const dayStr = formatDateKey(entry.tzDate);
                        return dayStr >= startValue && dayStr <= endValue;
                    });
                }

                if (!filtered.length) {
                    tablesContainer.innerHTML = '<p style="color:#999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>';
                    return;
                }

                const grouped = new Map();
                filtered.forEach(entry => {
                    const dayKey = formatDateKey(entry.tzDate);
                    if (!grouped.has(dayKey)) {
                        grouped.set(dayKey, []);
                    }
                    grouped.get(dayKey).push(entry);
                });

                const dayRows = Array.from(grouped.entries())
                    .sort((a, b) => (a[0] > b[0] ? 1 : -1))
                    .map(([dayKey, entries]) => {
                        entries.sort((a, b) => a.tzDate - b.tzDate);
                        const dateLabel = entries[0].tzDate.toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });

                        const timeGroups = new Map();
                        entries.forEach(entry => {
                            const timeKey = entry.tzDate.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                            if (!timeGroups.has(timeKey)) {
                                timeGroups.set(timeKey, []);
                            }
                            timeGroups.get(timeKey).push(entry);
                        });

                        const timeColumns = Array.from(timeGroups.entries())
                            .sort((a, b) => {
                                const [ah, am] = a[0].split(':').map(Number);
                                const [bh, bm] = b[0].split(':').map(Number);
                                return (ah * 60 + am) - (bh * 60 + bm);
                            })
                            .map(([timeKey, items]) => {
                                const rows = items
                                    .map(item => `
                                        <div class="period-entry">
                                            <span class="period-entry-price">${formatCurrency(item.price)}</span>
                                            <span class="period-entry-qty">${formatQuantity(item.quantity)}</span>
                                        </div>
                                    `)
                                    .join('');

                                return `
                                    <div class="period-time-column">
                                        <div class="period-time-label">${timeKey}</div>
                                        ${rows}
                                    </div>
                                `;
                            })
                            .join('');

                        return `
                            <div class="period-day" data-expanded="false">
                                <div class="period-day-header">
                                    <div class="period-day-title">${dateLabel}</div>
                                    <span class="period-day-toggle">–ü–æ–∫–∞–∑–∞—Ç—å</span>
                                </div>
                                <div class="period-day-content">
                                    <div class="period-row-columns">
                                        ${timeColumns}
                                    </div>
                                </div>
                            </div>
                        `;
                    })
                    .join('');

                tablesContainer.innerHTML = dayRows;

                tablesContainer.querySelectorAll('.period-day').forEach(dayEl => {
                    dayEl.addEventListener('click', (event) => {
                        const content = dayEl.querySelector('.period-day-content');
                        if (content && content.contains(event.target)) {
                            return;
                        }
                        togglePeriodDay(dayEl);
                    });
                });

            } catch (error) {
                console.error(`Error loading period analytics for item ${itemId}:`, error);
                tablesContainer.innerHTML = `<p style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const timezoneSelect = document.getElementById('timezone-select');
            if (timezoneSelect) {
                currentTimezoneOffsetMinutes = Number(timezoneSelect.value || 180);
                timezoneSelect.addEventListener('change', () => {
                    currentTimezoneOffsetMinutes = Number(timezoneSelect.value || 0);
                    if (isAuthenticated()) {
                        loadData();
                    }
                });
            }

            setupAuthHandlers();
            if (requireAuth()) {
                loadData();
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>