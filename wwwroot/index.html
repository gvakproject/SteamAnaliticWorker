<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            margin: 0;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .add-item-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .add-item-form h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .item-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .item-header h3 {
            color: #667eea;
            margin: 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .control-group label {
            font-size: 14px;
            color: #666;
        }

        .control-group select {
            padding: 8px;
            border: 2px solid #eee;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Steam Analytics Dashboard</h1>
            <div>
                <button class="btn btn-success" onclick="triggerCollection()" id="collectBtn">
                    üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
                </button>
                <button class="btn" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div class="summary" id="summary">
            <div class="summary-card">
                <h3>–í—Å–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h3>
                <div class="value" id="totalItems">-</div>
            </div>
            <div class="summary-card">
                <h3>–ó–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø–æ–∫—É–ø–∫—É</h3>
                <div class="value" id="totalBuyOrders">-</div>
            </div>
            <div class="summary-card">
                <h3>–ó–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</h3>
                <div class="value" id="totalSellOrders">-</div>
            </div>
            <div class="summary-card">
                <h3>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h3>
                <div class="value" id="lastUpdate" style="font-size: 14px;">-</div>
            </div>
        </div>

        <div class="add-item-form">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è</h2>
            <form onsubmit="addItem(event)">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</label>
                    <input type="text" id="itemName" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: AK-47 | Redline">
                </div>
                <div class="form-group">
                    <label>Item ID (–∏–∑ Steam)</label>
                    <input type="text" id="itemId" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12345678">
                </div>
                <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
            </form>
        </div>

        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="items" style="display: none;"></div>
    </div>

    <script>
        let charts = {};

        async function loadData() {
            try {
                document.getElementById('error').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                document.getElementById('items').style.display = 'none';

                // –ó–∞–≥—Ä—É–∂–∞–µ–º summary
                const summaryRes = await fetch('/api/analytics/summary');
                if (!summaryRes.ok) {
                    throw new Error(`HTTP error! status: ${summaryRes.status}`);
                }
                const summary = await summaryRes.json();
                
                document.getElementById('totalItems').textContent = summary.totalItems || 0;
                document.getElementById('totalBuyOrders').textContent = summary.totalBuyOrders || 0;
                document.getElementById('totalSellOrders').textContent = summary.totalSellOrders || 0;
                
                if (summary.lastUpdate && summary.lastUpdate !== '0001-01-01T00:00:00') {
                    const date = new Date(summary.lastUpdate);
                    document.getElementById('lastUpdate').textContent = date.toLocaleString('ru-RU');
                } else {
                    document.getElementById('lastUpdate').textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
                const itemsRes = await fetch('/api/analytics/items');
                if (!itemsRes.ok) {
                    throw new Error(`HTTP error! status: ${itemsRes.status}`);
                }
                const items = await itemsRes.json();

                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
                Object.values(charts).forEach(chart => chart.destroy());
                charts = {};

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
                const itemsHtml = await Promise.all(items.map(async (item) => {
                    let analytics;
                    try {
                        const analyticsRes = await fetch(`/api/analytics/items/${item.id}/analytics`);
                        if (!analyticsRes.ok) {
                            const errorText = await analyticsRes.text();
                            console.error(`Failed to load analytics for item ${item.id}: ${analyticsRes.status} - ${errorText}`);
                            return `
                                <div class="item-section">
                                    <div class="item-header">
                                        <h3>${item.name}</h3>
                                        <div style="font-size: 12px; color: #999;">ID: ${item.itemId}</div>
                                    </div>
                                    <p style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö (HTTP ${analyticsRes.status}). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.</p>
                                </div>`;
                        }
                        analytics = await analyticsRes.json();
                    } catch (error) {
                        console.error(`Error loading analytics for item ${item.id}:`, error);
                        return `
                            <div class="item-section">
                                <div class="item-header">
                                    <h3>${item.name}</h3>
                                    <div style="font-size: 12px; color: #999;">ID: ${item.itemId}</div>
                                </div>
                                <p style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</p>
                            </div>`;
                    }
                    
                    const timeSeriesRes = await fetch(`/api/analytics/items/${item.id}/time-series?grouping=hour&days=7`);
                    let timeSeries = [];
                    if (timeSeriesRes.ok) {
                        try {
                            timeSeries = await timeSeriesRes.json();
                        } catch (e) {
                            console.error(`Failed to parse time-series for item ${item.id}:`, e);
                            timeSeries = [];
                        }
                    }
                    
                    return `
                        <div class="item-section">
                            <div class="item-header">
                                <h3>${item.name}</h3>
                                <div style="font-size: 12px; color: #999;">
                                    ID: ${item.itemId} | –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(item.lastUpdated).toLocaleString('ru-RU')}
                                </div>
                            </div>

                            <div class="tabs">
                                <button class="tab active" onclick="switchTab(${item.id}, 'overview')">–û–±–∑–æ—Ä</button>
                                <button class="tab" onclick="switchTab(${item.id}, 'charts')">–ì—Ä–∞—Ñ–∏–∫–∏</button>
                                <button class="tab" onclick="switchTab(${item.id}, 'table')">–¢–∞–±–ª–∏—Ü–∞</button>
                            </div>

                            <div id="item-${item.id}-overview" class="tab-content active">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <h4>üõí –ó–∞–∫–∞–∑—ã –Ω–∞ –ø–æ–∫—É–ø–∫—É</h4>
                                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${analytics.buyOrders?.count || 0}</p>
                                        <p><strong>–ú–∏–Ω. —Ü–µ–Ω–∞:</strong> ${analytics.buyOrders?.minPrice ? analytics.buyOrders.minPrice.toFixed(2) + ' ‚Ç∏' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                                        <p><strong>–ú–∞–∫—Å. —Ü–µ–Ω–∞:</strong> ${analytics.buyOrders?.maxPrice ? analytics.buyOrders.maxPrice.toFixed(2) + ' ‚Ç∏' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                                        <p><strong>–í—Å–µ–≥–æ:</strong> ${analytics.buyOrders?.totalQuantity || 0} —à—Ç.</p>
                                        ${analytics.buyOrders?.count === 0 ? '<p style="color: #999; font-size: 12px; margin-top: 10px;">–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–±–æ—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</p>' : ''}
                                    </div>
                                    <div>
                                        <h4>üí∞ –ó–∞–∫–∞–∑—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</h4>
                                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${analytics.sellOrders?.count || 0}</p>
                                        <p><strong>–ú–∏–Ω. —Ü–µ–Ω–∞:</strong> ${analytics.sellOrders?.minPrice ? analytics.sellOrders.minPrice.toFixed(2) + ' ‚Ç∏' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                                        <p><strong>–ú–∞–∫—Å. —Ü–µ–Ω–∞:</strong> ${analytics.sellOrders?.maxPrice ? analytics.sellOrders.maxPrice.toFixed(2) + ' ‚Ç∏' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                                        <p><strong>–í—Å–µ–≥–æ:</strong> ${analytics.sellOrders?.totalQuantity || 0} —à—Ç.</p>
                                        ${analytics.sellOrders?.count === 0 ? '<p style="color: #999; font-size: 12px; margin-top: 10px;">–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–±–æ—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</p>' : ''}
                                    </div>
                                </div>
                            </div>

                            <div id="item-${item.id}-charts" class="tab-content">
                                <div class="controls">
                                    <div class="control-group">
                                        <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:</label>
                                        <select id="grouping-${item.id}" onchange="updateCharts(${item.id})">
                                            <option value="hour">–ü–æ —á–∞—Å–∞–º</option>
                                            <option value="day">–ü–æ –¥–Ω—è–º</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label>–ü–µ—Ä–∏–æ–¥:</label>
                                        <select id="days-${item.id}" onchange="updateCharts(${item.id})">
                                            <option value="1">1 –¥–µ–Ω—å</option>
                                            <option value="3">3 –¥–Ω—è</option>
                                            <option value="7" selected>7 –¥–Ω–µ–π</option>
                                            <option value="14">14 –¥–Ω–µ–π</option>
                                            <option value="30">30 –¥–Ω–µ–π</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="priceChart-${item.id}"></canvas>
                                </div>
                                <div class="chart-container">
                                    <canvas id="quantityChart-${item.id}"></canvas>
                                </div>
                            </div>

                            <div id="item-${item.id}-table" class="tab-content">
                                <div class="controls">
                                    <div class="control-group">
                                        <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:</label>
                                        <select id="table-grouping-${item.id}" onchange="updateTable(${item.id})">
                                            <option value="hour">–ü–æ —á–∞—Å–∞–º</option>
                                            <option value="day">–ü–æ –¥–Ω—è–º</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label>–ü–µ—Ä–∏–æ–¥:</label>
                                        <select id="table-days-${item.id}" onchange="updateTable(${item.id})">
                                            <option value="1">1 –¥–µ–Ω—å</option>
                                            <option value="3">3 –¥–Ω—è</option>
                                            <option value="7" selected>7 –¥–Ω–µ–π</option>
                                            <option value="14">14 –¥–Ω–µ–π</option>
                                            <option value="30">30 –¥–Ω–µ–π</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="table-content-${item.id}" style="min-height: 200px;">
                                    <p style="text-align: center; padding: 20px; color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã...</p>
                                </div>
                            </div>
                        </div>
                    `;
                }));

                const itemsContainer = document.getElementById('items');
                const loadingElement = document.getElementById('loading');
                
                if (!itemsContainer) {
                    throw new Error('Items container not found');
                }
                
                itemsContainer.innerHTML = itemsHtml.join('');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                itemsContainer.style.display = 'block';

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
                await new Promise(resolve => setTimeout(resolve, 100));
                
                for (const item of items) {
                    try {
                        await updateCharts(item.id);
                        await updateTable(item.id);
                    } catch (error) {
                        console.error(`Error initializing charts/table for item ${item.id}:`, error);
                    }
                }
            } catch (error) {
                const errorEl = document.getElementById('error');
                const loadingEl = document.getElementById('loading');
                
                if (errorEl) {
                    errorEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message;
                    errorEl.style.display = 'block';
                }
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
                console.error('Error loading data:', error);
            }
        }

        function switchTab(itemId, tabName) {
            // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç
            const overviewEl = document.getElementById(`item-${itemId}-overview`);
            if (!overviewEl) {
                console.warn(`Overview element not found for item ${itemId}`);
                return;
            }
            
            const itemSection = overviewEl.closest('.item-section');
            if (!itemSection) {
                console.warn(`Item section not found for item ${itemId}`);
                return;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            itemSection.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
            const targetTab = document.getElementById(`item-${itemId}-${tabName}`);
            if (targetTab) {
                targetTab.classList.add('active');
            } else {
                console.warn(`Tab ${tabName} not found for item ${itemId}`);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤–∫–ª–∞–¥–æ–∫
            itemSection.querySelectorAll('.tab').forEach((btn, idx) => {
                const tabs = ['overview', 'charts', 'table'];
                btn.classList.toggle('active', tabs[idx] === tabName);
            });
        }

        async function updateCharts(itemId) {
            const groupingEl = document.getElementById(`grouping-${itemId}`);
            const daysEl = document.getElementById(`days-${itemId}`);
            
            if (!groupingEl || !daysEl) {
                console.warn(`Chart controls not found for item ${itemId}, skipping`);
                return;
            }
            
            const grouping = groupingEl.value || 'hour';
            const days = daysEl.value || '7';
            
            try {
                const res = await fetch(`/api/analytics/items/${itemId}/time-series?grouping=${grouping}&days=${days}`);
                if (!res.ok) {
                    console.error(`Failed to load time-series for item ${itemId}: ${res.status}`);
                    return;
                }
                
                const text = await res.text();
                if (!text || text.trim() === '') {
                    console.warn(`Empty response for item ${itemId}`);
                    return;
                }
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error(`Failed to parse JSON for item ${itemId}:`, e, text);
                    return;
                }
                
                const buyData = data.find(d => d.type === 'buy')?.data || [];
                const sellData = data.find(d => d.type === 'sell')?.data || [];
                
                // –ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω
                const priceCtx = document.getElementById(`priceChart-${itemId}`);
                if (!priceCtx) {
                    console.warn(`Price chart canvas not found for item ${itemId}`);
                    return;
                }
                
                if (charts[`price-${itemId}`]) {
                    charts[`price-${itemId}`].destroy();
                }
                
                charts[`price-${itemId}`] = new Chart(priceCtx, {
                    type: 'line',
                    data: {
                        labels: buyData.map(d => new Date(d.time).toLocaleString('ru-RU')),
                        datasets: [
                            {
                                label: '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏',
                                data: buyData.map(d => d.avgPrice),
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            },
                            {
                                label: '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏',
                                data: sellData.map(d => d.avgPrice),
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '–î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(2) + ' ‚Ç∏';
                                    }
                                }
                            }
                        }
                    }
                });
                
                // –ì—Ä–∞—Ñ–∏–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                const quantityCtx = document.getElementById(`quantityChart-${itemId}`);
                if (!quantityCtx) {
                    console.warn(`Quantity chart canvas not found for item ${itemId}`);
                    return;
                }
                
                if (charts[`quantity-${itemId}`]) {
                    charts[`quantity-${itemId}`].destroy();
                }
                
                charts[`quantity-${itemId}`] = new Chart(quantityCtx, {
                    type: 'bar',
                    data: {
                        labels: buyData.map(d => new Date(d.time).toLocaleString('ru-RU')),
                        datasets: [
                            {
                                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø–æ–∫—É–ø–∫—É',
                                data: buyData.map(d => d.totalQuantity),
                                backgroundColor: 'rgba(75, 192, 192, 0.6)'
                            },
                            {
                                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É',
                                data: sellData.map(d => d.totalQuantity),
                                backgroundColor: 'rgba(255, 99, 132, 0.6)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        async function updateTable(itemId) {
            const groupingEl = document.getElementById(`table-grouping-${itemId}`);
            const daysEl = document.getElementById(`table-days-${itemId}`);
            const tableContentEl = document.getElementById(`table-content-${itemId}`);
            
            if (!groupingEl || !daysEl || !tableContentEl) {
                console.warn(`Table controls or content not found for item ${itemId}, skipping`);
                return;
            }
            
            const grouping = groupingEl.value || 'hour';
            const days = daysEl.value || '7';
            
            try {
                const res = await fetch(`/api/analytics/items/${itemId}/time-series?grouping=${grouping}&days=${days}`);
                if (!res.ok) {
                    tableContentEl.innerHTML = 
                        '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
                    return;
                }
                
                const text = await res.text();
                if (!text || text.trim() === '') {
                    tableContentEl.innerHTML = 
                        '<div style="text-align: center; padding: 40px;"><p style="color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p><p style="color: #999; font-size: 12px; margin-top: 10px;">–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–∞–±–ª–∏—Ü—É</p></div>';
                    return;
                }
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    tableContentEl.innerHTML = 
                        '<p style="color: red;">–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö</p>';
                    console.error(`Failed to parse JSON for table item ${itemId}:`, e);
                    return;
                }
                
                const buyData = data.find(d => d.type === 'buy')?.data || [];
                const sellData = data.find(d => d.type === 'sell')?.data || [];
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                const timeMap = new Map();
                
                buyData.forEach(d => {
                    const key = d.time;
                    if (!timeMap.has(key)) {
                        timeMap.set(key, { time: d.time, buy: d, sell: null });
                    } else {
                        timeMap.get(key).buy = d;
                    }
                });
                
                sellData.forEach(d => {
                    const key = d.time;
                    if (!timeMap.has(key)) {
                        timeMap.set(key, { time: d.time, buy: null, sell: d });
                    } else {
                        timeMap.get(key).sell = d;
                    }
                });
                
                const tableData = Array.from(timeMap.values()).sort((a, b) => 
                    new Date(a.time) - new Date(b.time)
                );
                
                if (tableData.length === 0) {
                    tableContentEl.innerHTML = 
                        '<div style="text-align: center; padding: 40px;"><p style="color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p><p style="color: #999; font-size: 12px; margin-top: 10px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</p></div>';
                    return;
                }
                
                const tableHtml = `
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>–í—Ä–µ–º—è</th>
                                    <th>–ü–æ–∫—É–ø–∫–∞ - –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</th>
                                    <th>–ü–æ–∫—É–ø–∫–∞ - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ü—Ä–æ–¥–∞–∂–∞ - –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</th>
                                    <th>–ü—Ä–æ–¥–∞–∂–∞ - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableData.map(row => `
                                    <tr>
                                        <td>${new Date(row.time).toLocaleString('ru-RU')}</td>
                                        <td>${row.buy ? row.buy.avgPrice.toFixed(2) + ' ‚Ç∏' : '-'}</td>
                                        <td>${row.buy ? row.buy.totalQuantity : '-'}</td>
                                        <td>${row.sell ? row.sell.avgPrice.toFixed(2) + ' ‚Ç∏' : '-'}</td>
                                        <td>${row.sell ? row.sell.totalQuantity : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                const contentEl = document.getElementById(`table-content-${itemId}`);
                if (contentEl) {
                    contentEl.innerHTML = tableHtml;
                } else {
                    console.warn(`Table content element not found for item ${itemId}`);
                }
            } catch (error) {
                const contentEl = document.getElementById(`table-content-${itemId}`);
                if (contentEl) {
                    contentEl.innerHTML = 
                        '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ' + error.message + '</p>';
                } else {
                    console.error(`Error updating table for item ${itemId}:`, error);
                }
            }
        }

        async function triggerCollection() {
            const btn = document.getElementById('collectBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...';
            
            try {
                const res = await fetch('/api/analytics/collect', {
                    method: 'POST'
                });
                
                if (res.ok) {
                    alert('–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—â–µ–Ω! –î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.');
                    setTimeout(() => loadData(), 5000);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö';
            }
        }

        async function addItem(event) {
            event.preventDefault();
            
            const name = document.getElementById('itemName').value;
            const itemId = document.getElementById('itemId').value;

            try {
                const response = await fetch('/api/analytics/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, itemId })
                });

                if (response.ok) {
                    document.getElementById('itemName').value = '';
                    document.getElementById('itemId').value = '';
                    loadData();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadData();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
